<Project>
    <PropertyGroup>
        <TargetFramework>net6.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
    </PropertyGroup>

    <PropertyGroup>
        <OutputPath>..\out\$(Configuration)</OutputPath>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <GenerateAssemblyInformationalVersionAttribute>false</GenerateAssemblyInformationalVersionAttribute>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="TShock" Version="5.2.0">
            <ExcludeAssets>contentFiles</ExcludeAssets>
        </PackageReference>
    </ItemGroup>

    <ItemGroup>
        <Compile Include="..\Localizer\**\*.cs">
            <Link>%(RecursiveDir)%(Filename)%(Extension)</Link>
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </Compile>
    </ItemGroup>

    <Target Name="CheckMsgfmtCallable">
        <Exec Command="msgfmt --help > NUL" IgnoreExitCode="True" Condition=" '$(OS)' == 'Windows_NT' ">
            <Output TaskParameter="ExitCode" PropertyName="MsgfmtExitCode" />
        </Exec>
        <Exec Command="msgfmt --help 2>/dev/null >/dev/null" IgnoreExitCode="True" Condition=" '$(OS)' != 'Windows_NT' ">
            <Output TaskParameter="ExitCode" PropertyName="MsgfmtExitCode" />
        </Exec>
    </Target>

    <Target
            Name="GenerateMOFiles"
            DependsOnTargets="CheckMsgfmtCallable"
            BeforeTargets="PrepareForBuild"
            Inputs="i18n\*.po"
            Outputs="i18n\*.mo">
        <ItemGroup Condition="'$(MsgfmtExitCode)' == '0'">
            <POFiles Include="i18n\*.po" />
        </ItemGroup>
        <Exec Command="msgfmt -o i18n/%(Filename).mo @(POFiles)" Outputs="i18n\*.mo" Condition="'$(MsgfmtExitCode)' == '0' And Exists(@(POFiles))">
            <Output ItemName="Generated" TaskParameter="Outputs"/>
        </Exec>

        <ItemGroup>
            <EmbeddedResource Include="i18n/%(FileName).mo" Condition="Exists(@(POFiles))">
                <LogicalName>i18n.%(FileName).mo</LogicalName>
            </EmbeddedResource>
        </ItemGroup>
    </Target>

    <Target Name="githash" BeforeTargets="PreBuildEvent">
        <Exec Command="git log -1 --pretty=&quot;format:%25H&quot;" ContinueOnError="true" ConsoleToMSBuild="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="CommitHashValue"/>
        </Exec>

        <ItemGroup>
            <AssemblyAttribute Include="System.Reflection.AssemblyInformationalVersionAttribute">
                <_Parameter1>$(CommitHashValue)</_Parameter1>
            </AssemblyAttribute>
        </ItemGroup>
    </Target>
</Project>